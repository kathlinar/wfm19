<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mainframe</title>

    <script src="js/vue.js"></script>
    <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/bootstrap-vue.css"/>
    <link type="text/css" rel="stylesheet" href="css/vue-datetime.css"/>
    <link type="text/css" rel="stylesheet" href="css/util.css"/>
    <script src="js/axios.min.js"></script>
    <script src="js/bootstrap-vue.js"></script>
    <script src="js/luxon.js"></script>
    <script src="js/vue-datetime.js"></script>

</head>
<body>
<div id="app">
    <div v-show="authorized">
        <b-navbar toggleable="lg" type="dark" variant="info">
            <b-navbar-brand href="#">locally</b-navbar-brand>

            <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

            <b-collapse id="nav-collapse" is-nav>
                <b-navbar-nav>
                    <b-nav-item @click="goTo">Mainpage</b-nav-item>
                </b-navbar-nav>
                <b-navbar-nav class="ml-auto">

                    <b-nav-item-dropdown right>
                        <template slot="button-content"><em>{{email}}</em></template>
                        <b-dropdown-item @click="logout">Sign Out</b-dropdown-item>
                    </b-nav-item-dropdown>
                </b-navbar-nav>
            </b-collapse>
        </b-navbar>
    </div>
    <b-table id="table" style="padding-top: 3%; padding-left: 15%; padding-right: 15%" bordered outlined striped responsive
                 :fields="fields" :items="items" class="text-center" v-show="authorized">
        <template slot="cancel" scope="item">
            <b-btn class="text-center" size="sm" @click="cancel(item.item)" :disabled="cancelDisabled(item.item)">Cancel</b-btn>
        </template>
        <template slot="attended" scope="item">
            <b-btn class="text-center" size="sm" @click="attended(item.item)" :disabled="attendedDisabled(item.item)">Attend</b-btn>
        </template>
        <template slot="feedback" scope="item">
            <b-btn class="text-center" size="sm" @click="saveRID(item.item)" :disabled="!isDisabled(item.item)">Feedback</b-btn>
        </template>
    </b-table>

    <b-modal id="reservation" v-model="modalShow" :title="modalTitle" hide-footer @hidden="reload">
        <div class="d-block text-center">
            <h4>{{reservationTxt}}</h4>
        </div>
    </b-modal>
    <b-modal id="modal-1" v-model="modalShow2" title="Feedback" @ok="feedback()" @hidden="reload">
        <b-form-textarea
                id="textarea-auto-height"
                v-model="text"
                placeholder="Please write your feedback here if you attended the experience."
                rows="3"
                max-rows="8"
                v-show="showTextArea"
        ></b-form-textarea>
        <h4 v-show="!showTextArea">You already gave a feedback to this experience</h4>
    </b-modal>


    <h2 v-show="!authorized">You are not permitted to access this page, whether due to wrong email address or you are not logged in yet</h2>

</div>
</body>
<script>
    var vue = new Vue({
        el: '#app',
        data: {
            datetime: '',
            reservationTxt: '',
            modalShow: false,
            modalShow2: false,
            email: '',
            authorized: true,
            text: '',
            rID: '',
            modalTitle: '',
            showTextArea: true,
            fields: {
                name:{
                    label: 'Name',
                    sortable: true
                },
                description: {
                    label: 'Description',
                    sortable: false
                },
                reservationDate: {
                    label: 'Reservation Date',
                    sortable: true
                },
                durationString: {
                    label: 'Duration',
                    sortable: false
                },
                startTime: {
                    label: 'Start',
                    sortable: true
                },
                price:{
                    label: 'Price (â‚¬)',
                    sortable: true
                },
                type:{
                    label: 'Type',
                    sortable: true
                },
                status:{
                    label: 'Status',
                    sortable: false
                },
                address: {
                    label: 'Address',
                    sortable: false
                },
                cancel:{
                    label: 'Cancel',
                },
                attended: {
                    label: 'Attend',
                },
                feedback: {
                    label: 'Feedback'
                }

            },
            items: [],
        },
        created() {
            let that = this;
            this.baseUrl = window.location.origin + "/";
            var url = new URL(window.location.href);
            this.email = url.searchParams.get("email");
            axios.get(this.baseUrl + "getBookedExperiences/" + this.email).then(response => {
                console.log(response.data);
                this.items = response.data;
            });
            axios.get(this.baseUrl + "checkLoginState/"+this.email).then(response => {
                that.authorized = true;
            }).catch(function (error) {
                that.authorized = false;
            });

        },
        methods:{
            reload(){
                window.location.href = "registeredExperiences.html?email="+this.email;
            },
            goTo(){
                window.location.href = "mainpage.html?email="+this.email;
            },
            cancel(item) {
                let _this = this;
                if(item.status === "CONFIRMED") {
                    axios.post('/cancelReservation', {
                        reservationId: item.id,
                        date: item.reservationDate,
                        email: this.email,
                    }).then(function (response) {
                        _this.modalTitle = 'Cancellation';
                        _this.reservationTxt = 'The cancellation of ' + item.name + ' was successful';
                        _this.modalShow = true;
                    })
                        .catch(function (error) {
                            _this.modalTitle = 'Cancellation';
                            _this.reservationTxt = 'There was an error on the cancellation of ' + item.name;
                            _this.modalShow = true;
                        });
                }
            },
            attended(item){

                let _this = this;
                if(item.status !== "CONFIRMED"){
                    _this.modalTitle = 'Attendance';
                    _this.reservationTxt = 'Experience is has to be confirmed in order to be attended';
                    _this.modalShow = true;
                } else if (item.attended === true) {
                    _this.modalTitle = 'Attendance';
                    _this.reservationTxt = item.name + ' already attended';
                    _this.modalShow = true;
                } else if (item.status === "CONFIRMED") {
                    axios.post('/attendExperience', {
                        reservationId: item.id,
                        email: this.email,
                    }).then(function (response) {
                        _this.modalTitle = 'Attendance';
                        _this.reservationTxt = 'The attendance of ' + item.name + ' was successful';
                        _this.modalShow = true;
                        item.attended = true;
                    })
                        .catch(function (error) {
                            _this.modalTitle = 'Attendance';
                            _this.reservationTxt = 'There was an error on the attendance of ' + item.name;
                            _this.modalShow = true;
                        });
                }
            },
            feedback(){
              let _this = this;
                if(this.showTextArea){
                    axios.post('/sendFeedback', {
                        reservationId: this.rID,
                        email: this.email,
                        feedback: this.text,
                    }).then(function (response) {

                    })
                    .catch(function (error) {
                        _this.modalShow = true;
                    });
                    this.text = '';
                }
                this.modalShow2 = false;
            },
            logout() {
                axios.post('logout', {
                    email: this.email
                }).then(function (response) {
                    console.log(response);
                    window.location.href = "login.html";
                }).catch(function (error) {
                    console.log(error);
                });
            },
            saveRID(item) {
                this.rID = item.id;
                this.modalShow2 = true;
                if(item.feedback === null)
                    this.showTextArea = true;
                else
                    this.showTextArea = false;

            },

            isDisabled(item){
                return (new Date()>= new Date(item.reservationDate)) && (item.attended === true) && item.status === "CONFIRMED_AND_ATTENDED";
            },

            cancelDisabled(item) {
                return (item.attended === true || item.status !== "CONFIRMED");
            },
            attendedDisabled(item){
                return item.status !== "CONFIRMED";
            },

        },


    });
</script>
</html>